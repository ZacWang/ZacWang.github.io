---
title: 除了一个小bug
date: 2016-03-08 16:06:00
categories: debug
tags:
---

昨天发现的一个小bug，搞了一天才搞通。

调用函数发生未期望的数组修改。原因是，传递的其他参数空间申请出了错。

<!--more-->

**问题描述**
在用fortran写的程序中调用metis的接口，调用之后传递的数组值被改变了，这个事情在之前调用的时候并没有发生过。相关数组是 ia, perm, iperm。 ia的值本应保持不变，但在这次调用过程中发生了变化。

由于metis本身并没有提供官方fortran接口，同时说实话他的manual写的太简略了……所以我一度认为是metis没有把这个接口写好。后来和老师讨论了好一会儿，还是决定把metis的接口单独拎出来写个demo看看会不会出这个问题。

老师的本意是想让我自己重新写一个demo，我自作主张拿原来的程序中的代码拼了一个小demo，run的时候发现perm, iperm未定义。才想起来回去找perm，iperm的定义和分配空间的语句。

结果找到之后发现perm, iperm分配的空间没有随着我的算例大小变化一起动态分配，即空间分配小了。因此在调用metis的接口时，metis对perm，iperm进行写操作过程中，会越界写入ia的空间中，最终的结果就导致了ia数组发生了变化。

后来再看，确实觉得ia数组并不是在metis中被释放了，其被修改后的数据并不是随机值，而是很接近perm中的数据形式。

**谈谈教训**
教训嘛，发现数组被改掉之后可以看看被改掉的数据是什么，如果像某一个别的数组，那很可能是被那个数组越界写操作给覆盖了，也许可以依据此回溯到究竟是哪出的问题。
哦对了，还有就是函数调用的时候，传递多个数组参数，有数组被意外写进去东西时，可能是其他数组分配空间不匹配造成的数组越界行为。